from flask import send_file

@app.route('/generate', methods=['POST'])
def generate():
    # ... collect and process form data ...

    scheduler = EnhancedScheduler(...)
    algorithm = request.form.get('algorithm')

    if algorithm == 'greedy':
        success = scheduler.generate_schedule_greedy()
    else:
        success = scheduler.generate_schedule()

    if success and scheduler.schedule:
        csv_path = "static/schedule.csv"
        scheduler.export_to_csv(csv_path)

        # Convert schedule into list of dictionaries for display
        schedule_data = []
        for (subject, group, session_index), (day, slot, room) in sorted(scheduler.schedule.items(), key=lambda x: (x[1][0], x[1][1])):
            teacher = scheduler.subjects[subject]['teacher']
            schedule_data.append({
                'day': day,
                'slot': f"Slot {slot + 1}",
                'group': group,
                'subject': subject,
                'teacher': teacher,
                'room': room,
                'session': session_index + 1
            })

        return render_template('schedule_display.html', schedule=schedule_data)
    
    return render_template('error.html', message="Failed to generate schedule.")
